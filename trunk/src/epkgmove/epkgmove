#!/usr/bin/env python2
# Copyright 1999-2004 Gentoo Technologies, Inc.
# Distributed under the terms of the GNU General Public License v2
# $Header$
#
# Author: 
#  Ian Leitch <port001@gentoo.org>
#
# ChangeLog:
#
#  4 Jun 2004 - epkgmove-0.5
#    - Fixed bug where epkgmove would fail if files/ contained subdirectories
#    - Add the package to its new location before removing it from the original
#    - Filter out non-update files in profiles/updates
#    - Backup to /tmp/__productname__/package and make a little extra effort to keep clean
#    - Small input validation fix
#
#  12 Feb 2004 - epkgmove-0.4,
#    - Set PORTDIR to pwd if not in PORTDIR
#    - Formatting fixes
#
#  02 Jan 2004 - epkgmove-0.3,
#    - Check exit status of commands, die if non zero
#    - Check if PORTDIR is a CVS repository
#    - Name changed to epkgmove
#  
#  02 Jan 2004 - pkgmove-0.2,
#    - Code cleanups
#    - Take only a catgegory name as destination argument
#    - Wrote the AddUpdate() function - thanks to lanius 
#    - Catch SIGINT
#    - err() now prints to stderr
#    - strip trailing /'s from input
#    - use -Qf flags on cvs commands
#    - Recursively find all files to remove/add
#    - Tested on local repository - command changes accordingly 
#    - Update categories before working in them
#
#  28 Dec 2003 - pkgmove-0.1,
#    - 0.1 Beta Release
#
# TODO:
#
#  - A complete rewrite. This was my first ever Python script and although I believe it to be safe to use,
#    it is not well structured at all.
#

import os
import re
import sys
import signal

import portage
from output import *

__author__ 	=	"Ian Leitch"
__email__ 	=	"port001@gentoo.org"
__productname__	= 	"epkgmove"
__version__ 	=	"0.5"
__description__	= 	"A simple tool for moving packages in CVS"

def main():
    
    signal.signal(signal.SIGINT, sighandler)
    
    global portdir, ignore, cvsrmcmd, cvscommitcmd, cvsupcmd, cvsaddcmd, devnull 
    
    portdir = portage.settings["PORTDIR"]
    ignore = ("CVS")
    cvsrmcmd = "cvs -Qf rm"
    cvscommitcmd = "cvs -Qf commit -m"
    cvsupcmd = "cvs -Qf up -dPC ."
    cvsaddcmd = "cvs -Qf add"
    devnull = "> /dev/null"

    if len(sys.argv) != 3:
        print
        err("Expected two arguments as input.")
        help()
        sys.exit(1)

    Checkcwd()
    CheckArgs()
    print "%s Moving %s to %s..." % (green(" *"), turquoise(location), yellow(destination))
    BackupPkg()
    AddPackage()
    RemovePackage()
    AddUpdate()
    CleanUp()
    print "%s %s successfully moved to %s." % (green(" *"), turquoise(location), yellow(destination))
    sys.exit(0)

def help():

    print
    print "%s %s [ %s ] [ %s ]" % (white("Usage:"), turquoise(__productname__), green("location"), green("destination")) 
    print "   %s: Expects a package name in the format 'category/pkg' e.g net-im/gaim" % (green("location"))
    print "   %s: Expects a category name" % (green("destination"))

def about():

    print
    print "%s %s %s" % (white("About:"), turquoise(__productname__), green(__version__))
    print "   \"%s\"" % (__description__)
    print "   By %s <%s>" % (__author__, __email__)

def docmd(cmd):

    retval = os.system(cmd)
    if retval != 0:
        err("Command '%s' failed with exit status %d." % (cmd, retval))
	sys.exit(1)

def err(msg):

    sys.stderr.write("%s ERROR: %s\n" % (red("!!!"), msg))

def sighandler(signal_number=None, stack_frame=None):

    err("Caught SIGINT; exiting...\n")
    sys.exit(1)
    os.kill(0,signal.SIGKILL)

def Checkcwd():

    global portdir

    if os.getcwd() != portdir:
        print "%s Not in PORTDIR!" % yellow(" *")
        print "%s Setting to: %s" % (yellow("   *"), os.getcwd())
        portdir = os.getcwd()

    files = os.listdir(portdir)
    
    for file in files:
        if not os.path.isdir(file):
	    files.remove(file)
	    
    if "CVS" not in files:
        err("No CVS directory, this doesn't look like a repository!")
	sys.exit(1)

def UpdateCats():

    print "%s Updating %s & %s..." % (green(" *"), locategory, decategory)

    os.chdir(os.path.join(portdir, locategory))
    docmd(cvsupcmd)
    os.chdir(os.path.join(portdir, decategory))
    docmd(cvsupcmd)

def CheckArgs():
    
    global fulllocation, location, fulldestination, destination, locategory, lopkg, decategory

    try:
        (locategory, lopkg) = sys.argv[1].strip('/').split('/')
    except:
        err("'%s' Invalid 'category/pkg'." % (sys.argv[1]))
	sys.exit(1)

    location = os.path.join(locategory, lopkg)
    decategory = sys.argv[2].strip('/')
    fulllocation = os.path.join(portdir, location)
    fulldestination = os.path.join(portdir, decategory, lopkg) 
    destination = os.path.join(decategory, lopkg)
   
    if re.search('/', decategory):
        err("Expected category name as destination argument.")
        sys.exit(1)

    if destination == location:
        err("Don't waste my time...")
	sys.exit(1)

    if not os.path.exists(os.path.join(portdir, decategory)):
        err("No such category '%s'" % (decategory))
	sys.exit(1)

    UpdateCats()

    if not os.path.exists(fulllocation):
        err("'%s' Invalid 'category/pkg'." % (location))
        sys.exit(1)

    if os.path.exists(fulldestination):
        err("Destination location '%s' already exists." % (destination))
        sys.exit(1)

    if not os.path.exists(os.path.join(portdir, "profiles/updates")):
        err("There doesn't seem to be a 'profiles/updates' directory here, I need it for later.")
        sys.exit(1)

def BackupPkg():

    print "%s Backing-up %s to /tmp/%s..." % (green("   *"), turquoise(location), __productname__)
    if not os.path.exists("/tmp/%s" % __productname__):
        os.mkdir("/tmp/%s" % __productname__)
    docmd("cp -R %s /tmp/%s/%s" % (fulllocation, __productname__, lopkg))

def RemovePackage():
    
    def RemoveFiles(arg, dir, files):
        if os.path.basename(dir) not in ignore:
	    for file in files:
	        if not os.path.isdir(os.path.join(dir, file)):
	            print "      <<< %s" % (os.path.join(dir.strip('./'), file))
	            os.unlink(os.path.join(dir, file))
	            docmd("%s %s" % (cvsrmcmd, os.path.join(dir, file)))
   
    print "%s Removing %s from CVS:" % (green("   *"), turquoise(location)) 
    os.chdir(fulllocation)
    os.path.walk('.', RemoveFiles , None)
    os.chdir("..")
    
    print "%s Running '%s 'Moving to %s''..." % (green("      *"), cvscommitcmd, destination)
    docmd("%s 'Moving to %s' %s" % (cvscommitcmd, destination, devnull))
    docmd("rm -rf " + fulllocation) 
    
    print "%s Checking if package still remains in CVS..." % (green("      *"))
    docmd(cvsupcmd)
   
    if not os.path.exists(fulllocation):
        print "%s %s successfully removed from CVS." % (green("   *"), turquoise(location))
    else:
        err("Remnants of %s still remain in CVS." % (turquoise(location)))

def AddPackage():

    def AddFiles(arg, dir, files):
        global dirhi
	dirhi = ""
	dest = ""
        if os.path.basename(dir) not in ignore:
            if os.path.basename(dir) != lopkg:
		(rubbish, dirhi) = dir.split("tmp/%s/%s/" % (__productname__, lopkg))
                print "      >>> %s/" % (dirhi)
		os.mkdir(os.path.join(fulldestination, dirhi))
                docmd("%s %s" % (cvsaddcmd, dirhi))
	    for file in files:
                if not os.path.isdir(os.path.join(dir, file)):
		    print "      >>> %s" % (os.path.join(dirhi, os.path.basename(file)))
		    if dirhi:	
		    	dest = dirhi
		    else:
		    	dest = "."
		    docmd("cp %s %s" % (os.path.join(dir, file), dest))
                    docmd("%s %s" % (cvsaddcmd, os.path.join(dirhi, file)))

    print "%s Adding %s to CVS:" % (green("   *"), turquoise(destination))

    os.chdir(os.path.join(portdir, decategory))
    print "      >>> %s/" % (lopkg)
    os.mkdir(lopkg)
    docmd("%s %s" % (cvsaddcmd,lopkg))
    os.chdir(lopkg)
    os.path.walk("/tmp/%s/%s" % (__productname__, lopkg), AddFiles , None)
    os.chdir(fulldestination)
    print "%s Running 'echangelog 'Moved from %s to %s.''..." % (green("      *"), location, destination) 
    docmd("echangelog 'Moved from %s to %s.' %s" % (location, destination, devnull))

    print "%s Running '%s 'Moved from %s to %s.''..." % (green("      *"), cvscommitcmd, location, destination)
    docmd("%s 'Moved from %s to %s.' %s" % (cvscommitcmd, location, destination, devnull))

    print "%s %s successfully added to CVS." % (green("   *"), turquoise(destination))

def AddUpdate():
    
    updatefiles = []
    fileregex = "^[\d]Q-[\d]{4}$"

    p_fileregex = re.compile(fileregex)
    
    print "%s Logging move in 'profiles/updates'..." % (green("   *")) 
    os.chdir(os.path.join(portdir, "profiles/updates"))
    docmd(cvsupcmd)

    for file in os.listdir("."):
        o_fileregex = p_fileregex.match(file)
        if file not in ignore and o_fileregex:
	    (q, y) =  file.split("-")
	    updatefiles.append(y + "-" + q)
	    
    updatefiles.sort()
    (y, q) = updatefiles[-1].split("-") 
    upfile = q + "-" + y

    print "      >>> %s" % (upfile)

    f = open(upfile, 'a')
    f.write("move %s %s\n" % (location, destination))
    f.close()

    docmd("%s 'Moved from %s to %s' %s" % (cvscommitcmd, location, destination, devnull))
    
    os.chdir(portdir)

def CleanUp():

    print "%s Removing back-up..." % (green("   *")) 
    docmd("rm -rf /tmp/%s/%s" % (__productname__, lopkg))
    if len(os.listdir("/tmp/%s" % __productname__)) == 0:
        docmd("rmdir /tmp/%s" % __productname__)

if __name__ == "__main__":
    main()

